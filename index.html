<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сообщество Историй</title>

  <!-- Стили -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Небольшой гарант для анимации баннера (на случай отсутствия правил в styles.css) -->
  <style>
    .bottom-banner{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:transform .35s ease, opacity .35s ease;opacity:.98;z-index:1000}
    .bottom-banner.show{transform:translateY(0)}
    .banner-hide-btn{cursor:pointer}
    .pagination{display:flex;gap:.5rem;justify-content:center}
    .pager-btn.active{font-weight:700}
    .ellipsis{padding:.25rem .5rem}
    .loading{padding:1rem;text-align:center}
  </style>

  <!-- Оптимизированный загрузчик историй (не блокируем рендер) -->
  <script src="optimized-loader.js" defer></script>

  <!-- Ваш Google Analytics-обёртка (не блокируем рендер) -->
  <script>
    // Очередь на случай ранних вызовов до инициализации реального трекера
    window.gaTrack = window.gaTrack || function(){ (window.gaQueue = window.gaQueue || []).push(arguments); };
  </script>
  <script src="google-analytics.js" defer></script>

  <!-- MGID: подключаем ОДИН раз -->
  <script src="https://jsc.mgid.com/site/1042649.js" async></script>

  <!-- Favicon / Apple Touch Icon -->
  <link rel="icon" href="images/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="images/apple-touch-icon.png" />
</head>
<body>
  <header class="site-header">
    <div class="container">
      <img src="images/Cupcake.svg" alt="" class="cupcake-left" width="50" height="50" aria-hidden="true" />
      <a href="/" class="logo">SWEET-STORY</a>
      <img src="images/Cupcake.svg" alt="" class="cupcake-right" width="50" height="50" aria-hidden="true" />
    </div>
  </header>

  <div class="container page-content">
    <main class="main-content" id="stories-container" aria-live="polite"></main>
    <div id="sidebar-container"></div>
  </div>

  <div class="container">
    <div id="pagination" class="pagination" role="navigation" aria-label="Пагинация"></div>
  </div>

  <footer class="site-footer">
    <div class="container">
      © 2025 Сообщество Историй
    </div>
  </footer>

  <!-- Bottom Banner -->
  <div id="bottomBanner" class="bottom-banner" role="region" aria-label="Рекомендуемые материалы">
    <div class="banner-header">
      <h3 class="banner-title">Рекомендуемые материалы</h3>
      <button id="hideBannerBtn" class="banner-hide-btn" aria-label="Скрыть баннер">Спрятать</button>
    </div>
    <div class="banner-content">
      <div class="banner-widget">
        <div data-type="_mgwidget" data-widget-id="1843264"></div>
      </div>
    </div>
  </div>

  <!-- JS: класс баннера -->
  <script>
    class BottomBanner {
      constructor() {
        this.banner = document.getElementById('bottomBanner');
        this.hideBtn = document.getElementById('hideBannerBtn');
        this.isVisible = false;
        this.showDelay = 3000; // мс
        this._onTransitionEnd = this._onTransitionEnd.bind(this);
        this.init();
      }

      init() {
        // Показываем баннер через задержку
        setTimeout(() => this.show(), this.showDelay);

        // Скрытие по кнопке — с защитой от отсутствия элемента
        if (this.hideBtn) {
          this.hideBtn.addEventListener('click', () => this.hide());
        }

        // Когда баннер полностью показан (есть transition), грузим виджет
        this.banner.addEventListener('transitionend', this._onTransitionEnd);

        // Пересчитываем отступ снизу при ресайзе, если баннер виден
        window.addEventListener('resize', () => {
          if (this.isVisible) document.body.style.marginBottom = this.getBannerHeight();
        });
      }

      _onTransitionEnd(e) {
        if (e.target === this.banner && this.isVisible) {
          this.loadMgidWidget();
        }
      }

      show() {
        if (this.isVisible) return;
        this.banner.classList.add('show');
        this.isVisible = true;
        document.body.style.marginBottom = this.getBannerHeight();

        // Фолбэк: если по каким-то причинам transition не сработает
        setTimeout(() => {
          if (window._mgq) this.loadMgidWidget();
        }, 400);
      }

      hide() {
        if (!this.isVisible) return;
        this.banner.classList.remove('show');
        this.isVisible = false;
        document.body.style.marginBottom = '0';
        // Не сохраняем состояние — баннер появится при следующем заходе
      }

      getBannerHeight() {
        const w = window.innerWidth;
        if (w <= 480) return '70vh';
        if (w <= 768) return '60vh';
        return '50vh';
      }

      loadMgidWidget() {
        // Грузим/перегружаем виджеты MGID строго после показа
        if (window._mgq) {
          window._mgq.push(['_mgc.load']);
        }
      }

      // Для ручного тестирования из консоли
      forceShow() { if (!this.isVisible) this.show(); }
    }
  </script>

  <!-- Сценарий страницы: загрузка историй, рендер карточек и пагинация (без innerHTML для небезопасных полей) -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Инициализация баннера
      window.bottomBanner = new BottomBanner();

      const container = document.getElementById('stories-container');
      const pagination = document.getElementById('pagination');
      const itemsPerPage = 12;
      let totalPages = 1;
      let currentPage = 1;
      let lastLoadToken = 0;

      function createStoryCard(story) {
        const card = document.createElement('article');
        card.className = 'story-card';

        const link = document.createElement('a');
        link.className = 'story-link';
        link.href = `story1.html?id=${encodeURIComponent(story.id)}`;
        link.addEventListener('click', () => {
          if (window.gaTrack) {
            window.gaTrack('story_click', {
              item_id: String(story.id),
              item_name: story.title || '',
              content_type: 'story_card'
            });
          }
        });

        const thumb = document.createElement('div');
        thumb.className = 'story-thumb';

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.src = story.image;
        img.alt = story.title || 'Иллюстрация к истории';

        const title = document.createElement('h2');
        title.className = 'story-title';
        title.textContent = story.title || '';

        const excerpt = document.createElement('p');
        excerpt.className = 'story-excerpt';
        excerpt.textContent = story.excerpt || '';

        thumb.appendChild(img);
        link.appendChild(thumb);
        link.appendChild(title);
        link.appendChild(excerpt);
        card.appendChild(link);
        return card;
      }

      function renderStories(stories) {
        container.replaceChildren();
        stories.forEach(story => container.appendChild(createStoryCard(story)));
      }

      function renderPagination(activePage, total, meta = {}) {
        const { fullyLoaded = false } = meta;
        pagination.replaceChildren();
        if (total <= 1 && fullyLoaded) return;

        const makeBtn = (label, page, isActive = false, aria) => {
          const btn = document.createElement('button');
          btn.className = 'pager-btn' + (isActive ? ' active' : '');
          btn.textContent = label;
          if (aria) btn.setAttribute('aria-label', aria);
          btn.disabled = isActive;
          btn.addEventListener('click', () => handlePageRequest(page, label));
          return btn;
        };

        if (activePage > 1) pagination.appendChild(makeBtn('←', activePage - 1, false, 'Предыдущая страница'));

        pagination.appendChild(makeBtn('1', 1, activePage === 1, 'Страница 1'));

        const lastPage = total;
        const windowStart = Math.max(2, activePage - 2);
        const windowEnd = Math.min(
          fullyLoaded ? Math.max(2, lastPage - 1) : lastPage,
          activePage + 2
        );

        if (windowStart > 2) {
          pagination.appendChild(Object.assign(document.createElement('span'), { className: 'ellipsis', textContent: '…' }));
        }

        for (let i = windowStart; i <= windowEnd; i++) {
          if (i >= lastPage && fullyLoaded) break;
          if (i <= 1) continue;
          pagination.appendChild(makeBtn(String(i), i, i === activePage, `Страница ${i}`));
        }

        if (fullyLoaded && lastPage > 1) {
          if (windowEnd < lastPage - 1) {
            pagination.appendChild(Object.assign(document.createElement('span'), { className: 'ellipsis', textContent: '…' }));
          }
          pagination.appendChild(makeBtn(String(lastPage), lastPage, activePage === lastPage, `Страница ${lastPage}`));
        } else if (!fullyLoaded && lastPage > 1 && windowEnd < lastPage) {
          pagination.appendChild(makeBtn(String(lastPage), lastPage, activePage === lastPage, `Страница ${lastPage}`));
        }

        if (activePage < total) {
          pagination.appendChild(makeBtn('→', activePage + 1, false, 'Следующая страница'));
        }
      }

      function handlePageRequest(page, label) {
        if (window.gaTrack) window.gaTrack('pagination_click', { page: Number(page), label: String(label) });
        showPage(page);
      }

      async function showPage(requestedPage = 1) {
        const token = ++lastLoadToken;
        const hasCache = window.storyLoader.hasRange(requestedPage, itemsPerPage);

        if (!hasCache) {
          container.innerHTML = '<div class="loading">Загружаем истории…</div>';
        }

        try {
          const result = await window.storyLoader.getPage(requestedPage, itemsPerPage);
          if (token !== lastLoadToken) return; // есть более свежий запрос

          currentPage = result.page;
          const stories = result.stories || [];

          if (!stories.length) {
            container.innerHTML = '<p>Истории пока недоступны. Загляните позже.</p>';
          } else {
            renderStories(stories);
          }

          const loadedPages = Math.max(1, Math.ceil(result.totalLoaded / itemsPerPage));
          totalPages = result.fullyLoaded
            ? Math.max(result.totalPages, loadedPages)
            : Math.max(loadedPages + 1, result.page + 1);

          renderPagination(currentPage, totalPages, { fullyLoaded: result.fullyLoaded });

          window.storyLoader.prefetchNext(itemsPerPage);
        } catch (err) {
          if (token !== lastLoadToken) return;
          console.error('Ошибка загрузки историй:', err);
          container.innerHTML = '<p>Не удалось загрузить истории. Попробуйте обновить страницу.</p>';
        }
      }

      try {
        container.innerHTML = '<div class="loading">Загружаем истории…</div>';
        await showPage(1);
      } catch (err) {
        console.error('Ошибка загрузки историй:', err);
        container.innerHTML = '<p>Не удалось загрузить истории. Попробуйте обновить страницу.</p>';
      }
    });
  </script>

  <!-- Сайдбар (не блокируем рендер) -->
  <script src="sidebar.js" defer></script>

  <!-- SEO-модуль как ES-модуль (браузеры грузят его отложенно по умолчанию) -->
  <script type="module">
    import { applySEOTags } from './seo.js';
    applySEOTags({
      title: 'Sweet Story — Сообщество Историй',
      description: 'Погрузитесь в мир увлекательных историй от авторов со всего мира.',
      url: window.location.href,
      image: 'https://www.sweet-story.com/images/og-image.jpg'
    });
  </script>

  <!-- Утилиты для ручного тестирования баннера из консоли -->
  <script>
    window.clearBannerData = function(){ localStorage.removeItem('bannerHidden'); console.log('localStorage очищен'); };
    window.showBanner = function(){ window.bottomBanner ? window.bottomBanner.forceShow() : console.log('Баннер ещё не инициализирован'); };
    window.hideBanner = function(){ window.bottomBanner ? window.bottomBanner.hide() : console.log('Баннер ещё не инициализирован'); };
    console.log('Команды: showBanner(), hideBanner(), clearBannerData()');
  </script>
</body>
</html>