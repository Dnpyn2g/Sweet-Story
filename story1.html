<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Сообщество Историй</title>

  <!-- Ваши стили -->
  <link rel="stylesheet" href="st.css">

  <!-- Оптимизированный загрузчик историй -->
  <script src="optimized-loader.js"></script>

  <!-- New Ad Script -->
  <script src="https://fpyf8.com/88/tag.min.js" data-zone="163736" async data-cfasync="false"></script>

  <!-- Favicon и Apple-touch-icon -->
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="images/apple-touch-icon.png">

</head>
<body>
  <header class="site-header">
    <div class="container">
      <a href="index.html" class="logo">← Назад</a>
      <button class="menu-toggle" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      </button>
      <nav class="main-nav">
        <a href="index.html">Главная</a>
        <a href="about.html">О нас</a>
        <a href="contact.html">Контакты</a>
      </nav>
    </div>
  </header>

  <div class="reading-progress" id="progress"></div>

  <div class="container">
    <div id="story-container">
      <!-- Здесь будет ваш контент истории -->
    </div>

    <div id="recommendations" class="recommendations" style="display:none">
      <!-- Здесь — блок «Читайте также» -->
    </div>
  </div>

  <footer class="site-footer">
    <div class="container">© 2025 Сообщество Историй</div>
  </footer>

  <!-- Bottom Banner -->
  <div id="bottomBanner" class="bottom-banner">
    <div class="banner-header">
      <h3 class="banner-title">Рекомендуемые материалы</h3>
      <button id="hideBannerBtn" class="banner-hide-btn">Спрятать</button>
    </div>
    <div class="banner-content">
      <div class="banner-widget">
        <div data-type="_mgwidget" data-widget-id="1828826"></div>
      </div>
    </div>
  </div>

  <script>
    // Управление нижним баннером
    class BottomBanner {
      constructor() {
        this.banner = document.getElementById('bottomBanner');
        this.hideBtn = document.getElementById('hideBannerBtn');
        this.isVisible = false;
        this.showDelay = 2000; // Показать через 2 секунды после загрузки истории
        this.init();
      }

      init() {
        // Показываем баннер через заданное время ПОСЛЕ загрузки истории
        console.log('Баннер будет показан через', this.showDelay, 'мс после загрузки истории');
        setTimeout(() => {
          this.show();
        }, this.showDelay);

        // Обработчик кнопки скрытия
        this.hideBtn.addEventListener('click', () => {
          this.hide();
        });

        // Загрузить рекламный виджет после показа баннера
        this.banner.addEventListener('transitionend', (e) => {
          if (e.target === this.banner && this.isVisible) {
            this.loadAdWidget();
          }
        });
      }

      show() {
        if (!this.isVisible) {
          console.log('Показываем баннер');
          this.banner.classList.add('show', 'animate-in');
          this.isVisible = true;
          
          // Добавляем отступ снизу в зависимости от размера экрана
          const bannerHeight = this.getBannerHeight();
          document.body.style.marginBottom = bannerHeight;
        }
      }

      hide() {
        console.log('hide() called, isVisible:', this.isVisible);
        if (this.isVisible) {
          console.log('Скрываем баннер');
          this.banner.classList.remove('show');
          this.banner.classList.remove('animate-in');
          this.isVisible = false;
          document.body.style.marginBottom = '0';
          
          // НЕ сохраняем состояние в localStorage - баннер будет появляться при каждом обновлении
        }
      }

      getBannerHeight() {
        const width = window.innerWidth;
        if (width <= 480) return '70vh';
        if (width <= 768) return '60vh';
        return '50vh';
      }

      loadAdWidget() {
        // Проверяем, что рекламные контейнеры существуют
        const inlineAd = document.getElementById('ad-inline-content');
        const endAd = document.getElementById('ad-end-content');
        
        if (inlineAd) {
          // Добавляем атрибут для fpyf8
          inlineAd.setAttribute('data-fpyf8', '163736');
          inlineAd.style.minHeight = '160px';
          inlineAd.style.width = '100%';
        }
        
        if (endAd) {
          // Добавляем атрибут для fpyf8
          endAd.setAttribute('data-fpyf8', '163736');
          endAd.style.minHeight = '160px';
          endAd.style.width = '100%';
        }
        
        // Если есть глобальная функция инициализации fpyf8
        if (typeof window.fpyf8Init === 'function') {
          window.fpyf8Init();
        }
        
        console.log('Ad widget loaded with fpyf8 data attributes');
      }
    }

    // Индикатор прогресса чтения
    document.addEventListener('scroll', () => {
      const prog = document.getElementById('progress');
      const height = document.documentElement.scrollHeight - window.innerHeight;
      prog.style.width = height
        ? (window.scrollY / height * 100) + '%'
        : '0';
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('story-container');
      const recContainer = document.getElementById('recommendations');
      const id = new URLSearchParams(window.location.search).get('id');

      if (!id) {
        container.innerHTML = '<p>Не указан ID истории.</p>';
        return; // Баннер НЕ инициализируется при отсутствии ID
      }

      try {
        // Показываем красивый индикатор загрузки
        container.innerHTML = `
          <div class="loading">
            Загружаем историю
            <div class="loading-dots">
              <div></div>
              <div></div>
              <div></div>
            </div>
          </div>
        `;

        // Используем оптимизированный загрузчик
        const story = await window.storyLoader.findStoryById(id);
        
        if (!story) {
          container.innerHTML = '<p>История не найдена.</p>';
          return; // Баннер НЕ инициализируется при ошибке
        }

        const pageUrl = encodeURIComponent(window.location.href);
        const paragraphs = story.content.split(/\r?\n/).filter(p => p.trim() !== '');

        // Рендер истории
        container.innerHTML = `
          <article class="story-detail">
            <h1 class="story-title">${story.title}</h1>
            <img src="${story.image}" alt="${story.title}" class="story-image">
            <div class="story-meta">Просмотров: ${story.views}</div>
            <div class="story-content"></div>
            <div class="btn-group">
              <a href="index.html" class="btn return-btn">Вернуться к списку</a>
              <a href="https://www.facebook.com/sharer/sharer.php?u=${pageUrl}"
                 target="_blank" class="btn share-btn">
                Поделиться историей
              </a>
            </div>
          </article>
        `;

        const contentDiv = container.querySelector('.story-content');
        paragraphs.forEach((p, index) => {
          contentDiv.insertAdjacentHTML('beforeend', `<p>${p}</p>`);
          
          // Добавляем рекламный виджет после 3-го абзаца (в середине статьи)
          if (index === 2 && paragraphs.length > 4) {
            const adWidget = document.createElement('div');
            adWidget.className = 'ad-widget-story ad-widget-inline';
            adWidget.innerHTML = '<div id="ad-inline-content" data-fpyf8="163736" style="min-height: 160px; width: 100%;"></div>';
            contentDiv.appendChild(adWidget);
          }
        });

        // Добавляем новый рекламный виджет в конце статьи, перед кнопками
        const btnGroup = container.querySelector('.btn-group');
        const endWidget = document.createElement('div');
        endWidget.className = 'ad-widget-story ad-widget-end';
        endWidget.innerHTML = '<div id="ad-end-content" data-fpyf8="163736" style="min-height: 160px; width: 100%;"></div>';
        btnGroup.insertAdjacentElement('beforebegin', endWidget);

        // Блок рекомендаций
        const randomStories = await window.storyLoader.getRandomStories(5);
        const others = randomStories.filter(item => String(item.id) !== id);
        
        recContainer.innerHTML = '<h3>Читайте также</h3><ul>' +
          others.map(o =>
            `<li><a href="story1.html?id=${o.id}">${o.title}</a></li>`
          ).join('') +
          '</ul>';
        
        recContainer.style.display = 'block';

        // Инициализация баннера ПОСЛЕ загрузки истории
        const bottomBanner = new BottomBanner();
        
        // Инициализация рекламы после создания всех контейнеров
        setTimeout(() => bottomBanner.loadAdWidget(), 500);

      } catch (error) {
        console.error('Ошибка загрузки истории:', error);
        container.innerHTML = '<p>Не удалось загрузить историю.</p>';
        return; // Баннер НЕ инициализируется при ошибке загрузки
      }

      // Toggle мобильного меню
      document.querySelector('.menu-toggle')
        .addEventListener('click', () => {
          document.querySelector('.main-nav').classList.toggle('open');
        });
    });
  </script>

  <!-- Ваши остальные скрипты -->
  <script src="comments.js"></script>
  
  <!-- Скрипт для виджета в баннере -->
  <script>
    // Загружаем виджет для баннера отдельно
    (function(w,q){w[q]=w[q]||[];w[q].push(["_mgc.load"])})(window,"_mgq");
    
    // Функция для сброса состояния баннера (для тестирования)
    window.resetBanner = function() {
      localStorage.removeItem('bannerHidden');
      location.reload();
    };
    
    // Выводим подсказку в консоль
    console.log('Баннер теперь появляется после каждого обновления страницы!');
  </script>
</body>
</html>